<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å­¦ç”Ÿä¸­å¿ƒ</title>
  <style>
    :root {
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --text-main: #1e293b;
      --text-muted: #64748b;
      --primary: #4f46e5;
      --primary-hover: #4338ca;
      --border: #e2e8f0;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', system-ui, sans-serif;
      color: var(--text-main);
      background: var(--bg);
      padding-top: 60px;
    }
    .topbar {
      position: fixed; top: 0; left: 0; right: 0; height: 60px;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 24px; background: rgba(255,255,255,0.95); backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--border); z-index: 100;
    }
    .brand { font-weight: 700; color: var(--text-main); }
    .logout-link { color: var(--text-muted); font-size: 14px; text-decoration: none; }
    
    .container { max-width: 800px; margin: 30px auto; padding: 0 20px; display: flex; flex-direction: column; gap: 30px;}
    
    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 24px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }
    .card-header { margin-bottom: 20px; border-bottom: 1px solid #f1f5f9; padding-bottom: 10px; }
    h2 { margin: 0; font-size: 18px; font-weight: 600; }
    h3 { font-size: 15px; font-weight: 600; margin: 0 0 10px 0; color: var(--text-main); }
    
    .info-bar { background: #eff6ff; color: #1e40af; padding: 12px; border-radius: 8px; font-size: 13px; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10px;}
    
    label { display: block; margin: 15px 0 8px 0; font-size: 13px; font-weight: 500; color: var(--text-muted); }
    input, textarea {
      width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border);
      outline: none; transition: .2s; font-family: inherit; font-size: 14px;
    }
    input:focus, textarea:focus { border-color: var(--primary); }
    
    .btn {
      background: var(--primary); color: #fff; border: none; padding: 10px 20px;
      border-radius: 8px; font-weight: 500; cursor: pointer; transition: .2s;
      display: inline-flex; align-items: center; justify-content: center;
    }
    .btn:hover { background: var(--primary-hover); transform: translateY(-1px); }
    .btn.secondary { background: #f1f5f9; color: var(--text-main); }
    .btn.secondary:hover { background: #e2e8f0; }
    .btn.full { width: 100%; margin-top: 10px; }
    
    /* æ ·å¼é€‰æ‹©ç½‘æ ¼ */
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 20px; margin-top: 20px; }
    .style-card {
      border: 1px solid var(--border); border-radius: 12px; overflow: hidden;
      background: #fff; transition: .2s;
    }
    .style-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.1); }
    .style-img {
      width: 100%; height: 180px; object-fit: cover; background: #f1f5f9;
    }
    .style-body { padding: 16px; }
    .style-title { font-weight: 600; font-size: 16px; margin-bottom: 4px; }
    .style-meta { font-size: 12px; color: var(--text-muted); margin-bottom: 12px; }
    
    /* å°ºç é€‰æ‹©å™¨ */
    .size-selector { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
    .size-opt { position: relative; }
    .size-opt input { position: absolute; opacity: 0; width: 0; height: 0; }
    .size-opt span {
      display: block; padding: 6px 12px; border: 1px solid var(--border); border-radius: 6px;
      font-size: 12px; cursor: pointer; transition: .2s; color: var(--text-main);
    }
    .size-opt input:checked + span {
      background: var(--primary); color: #fff; border-color: var(--primary);
    }

    .notice-list { display: flex; flex-direction: column; gap: 10px; }
    .notice-item {
      background: #f8fafc; padding: 12px; border-radius: 8px; border-left: 3px solid var(--primary);
      font-size: 14px; line-height: 1.5;
    }
    .notice-time { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; display: block; }
    
    .muted { color: var(--text-muted); font-size: 12px; }
    .mono { font-family: monospace; background: #eee; padding: 0 4px; border-radius: 3px; }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">å¯’è¡£è¡¥åŠ© Â· å­¦ç”Ÿç«¯</div>
    <a href="/student-login.html" class="logout-link" onclick="localStorage.clear()">é€€å‡ºç™»å½•</a>
  </div>
  
  <div class="container">
    
    <div class="info-bar">
      <span>ğŸ‘‹ æ¬¢è¿ï¼Œ<strong id="sName">åŒå­¦</strong></span>
      <span>ä¼šè¯ä»¤ç‰Œ: <span id="sToken" style="font-family:monospace; opacity:0.7">...</span></span>
    </div>

    <div class="card">
      <div class="card-header">
        <h2>æäº¤ç”³è¯·</h2>
      </div>
      <div style="display:flex; gap:15px; align-items:flex-end">
        <div style="flex:1">
          <label>å½“å‰æ‰¹æ¬¡ ID</label>
          <input id="applyBatchId" placeholder="ä¾‹å¦‚ï¼š1">
        </div>
        <div style="flex:3">
           <label>ç”³è¯·ç†ç”±</label>
           <textarea id="applyReason" rows="1" placeholder="è¯·ç®€è¿°æ‚¨çš„å›°éš¾æƒ…å†µ..."></textarea>
        </div>
      </div>
      <button class="btn full" id="applyBtn">æäº¤ç”³è¯·</button>
      <div class="muted" style="margin-top:10px; text-align:center">ç”³è¯·å›æ‰§ IDï¼š<span id="applyId" class="mono">-</span></div>
    </div>

    <div class="card">
      <div class="card-header">
        <h2>æ¬¾å¼é€‰æ‹©</h2>
      </div>
      <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px">
        <select id="selBatchIdStu" style="max-width:260px; padding:10px 12px; border-radius: 8px; border: 1px solid var(--border); outline:none"></select>
        <button class="btn secondary" id="loadStylesBtn">åŠ è½½æ¬¾å¼</button>
      </div>
      
      <div class="grid" id="stylesGrid">
        <div class="style-card" style="display:flex;align-items:center;justify-content:center;height:200px;background:#f8fafc;color:#999;grid-column:1/-1">
          æš‚æ— æ•°æ®ï¼Œè¯·é€‰æ‹©æ‰¹æ¬¡å¹¶åŠ è½½
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div style="display:flex; justify-content:space-between; align-items:center">
          <h2>ç³»ç»Ÿé€šçŸ¥</h2>
          <button class="btn secondary" id="loadNoticesBtn" style="padding:6px 12px; font-size:12px">åˆ·æ–°</button>
        </div>
      </div>
      <div class="notice-list" id="noticesOut">
        <div style="text-align:center; padding:20px; color:#999">æš‚æ— é€šçŸ¥</div>
      </div>
    </div>

  </div>

  <script>
    const api=path=>path
    const j=async r=>{if(!r.ok)throw new Error(await r.text());return r.json()}
    const b=()=>document.getElementById.bind(document)
    const stuHdr=()=>({"X-Student-Token":b()("sToken").textContent})
    
    const ensureLogin=()=>{
      const token=localStorage.getItem("studentToken")||""
      const name=localStorage.getItem("studentName")||""
      if(!token){location.href="/student-login.html";return false}
      b()("sToken").textContent=token
      b()("sName").textContent=name
      return true
    }

    const loadBatchesNow=async()=>{
      try{
        const list=await j(await fetch(api("/api/student/batches"),{headers:stuHdr()}))
        const sel=b()("selBatchIdStu")
        sel.innerHTML=""
        if(!list || list.length===0){
          const opt=document.createElement("option")
          opt.value=""
          opt.textContent="æš‚æ— æ‰¹æ¬¡"
          sel.appendChild(opt)
          b()("loadStylesBtn").disabled=true
          return
        }
        list.forEach(x=>{
          const opt=document.createElement("option")
          opt.value=String(x.id)
          opt.textContent=`æ‰¹æ¬¡ ${x.id} Â· ${x.difficultyLevel}`
          sel.appendChild(opt)
        })
        b()("loadStylesBtn").disabled=false
        if(!sel.value) sel.value=String(list[0].id)
      }catch(e){
        const sel=b()("selBatchIdStu")
        sel.innerHTML=""
        const opt=document.createElement("option")
        opt.value=""
        opt.textContent="æ‰¹æ¬¡åŠ è½½å¤±è´¥"
        sel.appendChild(opt)
        b()("loadStylesBtn").disabled=true
      }
    }

    const loadStylesNow=async()=>{
      if(!b()("sToken").textContent){alert("è¯·å…ˆç™»å½•");return}
      const batchId = b()("selBatchIdStu").value;
      if(!batchId) { alert("è¯·å…ˆé€‰æ‹©æ‰¹æ¬¡"); return; }
      
      try{
        const r=await j(await fetch(api("/api/student/styles"),{headers:stuHdr()}))
        const grid=b()("stylesGrid")
        grid.innerHTML=""
        if(r.length === 0) { grid.innerHTML = '<div style="padding:20px; text-align:center; color:#999; grid-column:1/-1">å½“å‰æ²¡æœ‰å¯é€‰æ¬¾å¼</div>'; return; }
        
        r.forEach(s=>{
          const div=document.createElement("div")
          div.className="style-card"
          const url=s.imageUrl||"https://via.placeholder.com/400x300?text=No+Image"
          
          // æ„å»ºå°ºç  Radio
          const radios=(s.variants||[]).map(v=>`
            <label class="size-opt">
              <input type="radio" name="size-${s.id}" value="${v.id}">
              <span>${v.sizeLabel}</span>
            </label>
          `).join("")

          div.innerHTML=`
            <img class="style-img" src="${url}" alt="${s.name}" loading="lazy">
            <div class="style-body">
              <div class="style-title">${s.name}</div>
              <div class="style-meta">${s.gender}æ¬¾</div>
              <div class="size-selector">${radios || '<span class="muted">æš‚æ— å°ºç </span>'}</div>
              <button class="btn full" data-style="${s.id}">ç¡®è®¤é€‰æ‹©</button>
              <div class="muted" style="margin-top:8px;text-align:center;min-height:1em">
                <span id="sel-out-${s.id}" style="color:var(--primary)"></span>
              </div>
            </div>`
          grid.appendChild(div)
          
          const btn=div.querySelector("button[data-style]")
          btn.onclick=async()=>{
            const batchId=b()("selBatchIdStu").value
            if(!batchId){alert("è¯·å…ˆé€‰æ‹©æ‰¹æ¬¡");return}
            const picked=div.querySelector(`input[name="size-${s.id}"]:checked`)
            if(!picked){alert("è¯·å…ˆé€‰æ‹©å°ºç ");return}
            
            try {
              const body=new URLSearchParams()
              body.set("batchId",batchId)
              body.set("variantId",picked.value)
              const resp=await j(await fetch(api("/api/student/select"),{method:"POST",headers:stuHdr(),body}))
              b()(`sel-out-${s.id}`).textContent = "âœ… å·²ç™»è®° (ID:" + resp.selectionId + ")"
            } catch(e) {
              alert("é€‰æ‹©å¤±è´¥: " + e.message)
            }
          }
        })
      }catch(e){
        alert("åŠ è½½å¤±è´¥ï¼š"+e.message)
      }
    }

    const loadNoticesNow=async()=>{
      try {
        const r=await j(await fetch(api("/api/student/notifications"),{headers:stuHdr()}))
        const box = b()("noticesOut")
        if(!r || r.length === 0) { box.innerHTML = '<div style="text-align:center; padding:10px; color:#999">æš‚æ— æ–°é€šçŸ¥</div>'; return; }
        
        box.innerHTML=r.map(n=>`
          <div class="notice-item">
            <span class="notice-time">${n.createdAt}</span>
            ${n.message}
          </div>
        `).join("")
      } catch(e) {
        b()("noticesOut").innerHTML = '<div style="text-align:center; padding:10px; color:#ef4444">é€šçŸ¥åŠ è½½å¤±è´¥</div>'
      }
    }

    if(ensureLogin()){
      loadBatchesNow()
      loadNoticesNow()
    }

    b()("applyBtn").onclick=async()=>{
      try {
        const body=new URLSearchParams()
        body.set("batchId",b()("applyBatchId").value)
        body.set("reason",b()("applyReason").value)
        const r=await j(await fetch(api("/api/student/apply"),{method:"POST",headers:stuHdr(),body}))
        b()("applyId").textContent=r.applicationId
        alert("ç”³è¯·æäº¤æˆåŠŸ")
      } catch(e) { alert("æäº¤å¤±è´¥: " + e.message) }
    }
    b()("loadStylesBtn").onclick=loadStylesNow
    b()("loadNoticesBtn").onclick=loadNoticesNow
    b()("selBatchIdStu").addEventListener("change",()=>{ b()("stylesGrid").innerHTML='<div class="style-card" style="display:flex;align-items:center;justify-content:center;height:200px;background:#f8fafc;color:#999;grid-column:1/-1">è¯·é€‰æ‹©æ‰¹æ¬¡ååŠ è½½æ¬¾å¼</div>' })
  </script>
</body>
</html>
