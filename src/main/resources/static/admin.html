<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç®¡ç†å‘˜æ§åˆ¶å°</title>
  <style>
    :root {
      --bg: #f1f5f9;
      --card-bg: #ffffff;
      --text-main: #1e293b;
      --text-muted: #64748b;
      --primary: #4f46e5;
      --primary-hover: #4338ca;
      --border: #e2e8f0;
      --danger: #ef4444;
      --warn: #f59e0b;
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.06);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', system-ui, sans-serif;
      color: var(--text-main);
      background: var(--bg);
      padding-top: 60px;
    }
    /* é¡¶éƒ¨å¯¼èˆª */
    .topbar {
      position: fixed; top: 0; left: 0; right: 0; height: 60px;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 32px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border); z-index: 100;
    }
    .brand { font-weight: 700; font-size: 16px; color: var(--text-main); display: flex; align-items: center; gap: 10px; }
    .brand span { padding: 4px 8px; background: #e0e7ff; color: var(--primary); border-radius: 4px; font-size: 12px; }
    .nav-btn { font-size: 14px; color: var(--text-muted); text-decoration: none; }
    .nav-btn:hover { color: var(--primary); }

    .container { max-width: 1280px; margin: 30px auto; padding: 0 20px; }
    
    /* ç½‘æ ¼å¸ƒå±€ä½“ç³» */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .full-width { grid-column: 1 / -1; }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      box-shadow: var(--shadow);
    }
    h2 { margin: 0 0 20px 0; font-size: 18px; font-weight: 600; color: var(--text-main); display: flex; align-items: center; gap: 8px;}
    h2::before { content: ''; width: 4px; height: 16px; background: var(--primary); border-radius: 2px; display: inline-block; }

    label { display: block; margin: 12px 0 6px 0; color: var(--text-muted); font-size: 13px; font-weight: 500; }
    input, select, textarea {
      width: 100%; padding: 10px 12px; border-radius: 6px;
      border: 1px solid var(--border); background: #fff;
      color: var(--text-main); font-size: 14px; outline: none; transition: .2s;
    }
    input:focus, select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
    textarea { min-height: 80px; resize: vertical; }

    .btn {
      display: inline-flex; align-items: center; justify-content: center;
      background: var(--primary); color: #fff; border: none;
      border-radius: 6px; padding: 10px 16px; font-size: 14px; font-weight: 500;
      cursor: pointer; transition: .2s; margin-top: 10px;
    }
    .btn:hover { background: var(--primary-hover); transform: translateY(-1px); }
    .btn.secondary { background: #fff; border: 1px solid var(--border); color: var(--text-main); }
    .btn.secondary:hover { background: #f8fafc; }
    .btn.warn { background: var(--warn); }
    .btn.danger { background: var(--danger); }
    .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }

    .muted { color: var(--text-muted); font-size: 12px; margin-top: 8px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; background: #f1f5f9; padding: 2px 4px; border-radius: 4px; }

    /* å®¡æ ¸åˆ—è¡¨æ ·å¼ */
    .list { background: #fff; border-radius: 8px; }
    .review-item {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .review-item:last-child { border-bottom: none; }
    .review-header { display: flex; justify-content: space-between; align-items: center; }
    .review-header b { font-size: 15px; }
    .status-row { display: flex; align-items: center; gap: 15px; background: #f8fafc; padding: 10px; border-radius: 6px; }
    .status-label { font-size: 13px; color: var(--text-muted); min-width: 60px; }
    
    /* Radio è‡ªå®šä¹‰ */
    .radio-group label { display: inline-flex; align-items: center; gap: 6px; margin: 0 10px 0 0; cursor: pointer; }
    .radio-group input { width: auto; margin: 0; }

    .toast-wrap { position: fixed; right: 20px; bottom: 20px; z-index: 999; display: flex; flex-direction: column; gap: 10px; }
    .toast { background: #fff; padding: 12px 20px; border-radius: 6px; border-left: 4px solid var(--primary); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); font-size: 14px; }
    .toast.error { border-color: var(--danger); }

    /* ç™»å½•å¡ç‰‡ç‰¹ä¾‹ */
    #adminLoginCard { max-width: 400px; margin: 80px auto; }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">å¯’è¡£è¡¥åŠ© <span>Admin</span></div>
    <a href="/student.html" class="nav-btn">åˆ‡æ¢è‡³å­¦ç”Ÿç«¯</a>
  </div>

  <div class="container">
    <div class="toast-wrap" id="toastWrap"></div>

    <div class="card" id="adminLoginCard">
      <h2>ç®¡ç†å‘˜ç™»å½•</h2>
      <label>ç”¨æˆ·å</label><input id="adminUsername" value="counselor1">
      <label>å¯†ç </label><input id="adminPassword" type="password" value="rjxy">
      <button class="btn" style="width:100%" id="adminLoginBtn">è¿›å…¥ç³»ç»Ÿ</button>
      <div class="muted" style="text-align:center">ä»…é™æˆæƒäººå‘˜è®¿é—®</div>
      
      <div id="loginInfo" style="display:none; margin-top:20px; border-top:1px solid #eee; padding-top:10px">
         <div class="muted">è§’è‰²ï¼š<span id="adminRole" class="mono"></span> ç”¨æˆ·ï¼š<span id="adminUser" class="mono"></span></div>
         <div id="roleSelectWrap" style="margin-top:10px">
           <label style="margin:0 0 5px 0">å½“å‰è§†å›¾æƒé™</label>
           <select id="roleSelect"><option value="counselor">è¾…å¯¼å‘˜</option><option value="college">å­¦é™¢</option><option value="school">å­¦æ ¡</option></select>
         </div>
      </div>
    </div>

    <div class="dashboard-grid" id="adminAppCards" style="display:none">
      
      <div class="card full-width" id="cardReview">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
           <h2 style="margin:0">ç”³è¯·å®¡æ ¸</h2>
           <div style="display:flex; gap:10px; align-items:center">
             <select id="revBatchIdInline" style="width:100px"><option value="1" selected>æ‰¹æ¬¡ 1</option></select>
             <select id="revPageSize" style="width:80px"><option>10</option><option selected>20</option><option>50</option></select>
             <button class="btn" id="loadAppsBtn" style="margin:0">åˆ·æ–°åˆ—è¡¨</button>
           </div>
        </div>
        <div id="appsList" class="list"></div>
      </div>

      <div class="card" id="cardCreateBatch">
        <h2>åˆ›å»ºæ–°æ‰¹æ¬¡</h2>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <div><label>æ‰¹æ¬¡å¹´ä»½</label><input id="batchYear" value="2025"></div>
          <div><label>å›°éš¾å­¦å¹´</label><input id="diffYear" value="2025"></div>
        </div>
        <label>å›°éš¾ç­‰çº§</label><select id="diffLevel"><option>HIGH</option><option>MEDIUM</option><option>LOW</option></select>
        <label>ç”³è¯·æˆªæ­¢æ—¶é—´ (ISO)</label><input id="applyDeadline" value="2025-12-31T23:59:59">
        <button class="btn" id="openBatchBtn">åˆ›å»ºæ‰¹æ¬¡</button>
        <div class="muted">æ‰¹æ¬¡IDï¼š<span id="openedBatchId" class="mono">-</span></div>
      </div>

      <div class="card" id="cardSelectionDeadline">
        <h2>é€‰è¡£æˆªæ­¢è®¾ç½®</h2>
        <label>æ‰¹æ¬¡ID</label><input id="selBatchId">
        <label>é€‰æ‹©æˆªæ­¢æ—¶é—´ (ISO)</label><input id="selDeadline" value="2026-01-20T23:59:59">
        <button class="btn" id="setSelDeadlineBtn">ä¿å­˜è®¾ç½®</button>
      </div>

      <div class="card" id="cardCreateStyle">
        <h2>æ¬¾å¼å½•å…¥</h2>
        <label>åç§°</label><input id="styleName" value="ç”·01æ¬¾">
        <label>æ€§åˆ«</label><select id="styleGender"><option>ç”·</option><option>å¥³</option></select>
        <label>å›¾ç‰‡é“¾æ¥</label><input id="styleImage" value="https://via.placeholder.com/300">
        <label>å°ºç å˜ä½“ (JSON)</label><textarea id="styleVariants" rows="3">[{"sizeLabel":"XL","productCode":"ç”·01æ¬¾XLç "},{"sizeLabel":"L","productCode":"ç”·01æ¬¾Lç "}]</textarea>
        <button class="btn" id="createStyleBtn">åˆ›å»ºæ¬¾å¼</button>
        <div class="muted">æ¬¾å¼IDï¼š<span id="createdStyleId" class="mono">-</span></div>
      </div>

      <div class="card" id="cardCreateStudent">
        <h2>å­¦ç”Ÿæ¡£æ¡ˆå½•å…¥</h2>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
           <div><label>å­¦å·</label><input id="stuNum" value="20250001"></div>
           <div><label>å§“å</label><input id="stuName" value="å¼ ä¸‰"></div>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
           <div><label>æ€§åˆ«</label><select id="stuGender"><option>ç”·</option><option>å¥³</option></select></div>
           <div><label>å…¥å­¦å¹´ä»½</label><input id="stuEntryYear" value="2025"></div>
        </div>
        <label>èº«ä»½è¯å·</label><input id="stuIdCard" value="123456199901011234">
        <label>å­¦é™¢</label><input id="stuCollege" value="ä¿¡æ¯å­¦é™¢">
        <label>å›°éš¾ç­‰çº§/å­¦å¹´</label>
        <div style="display:flex; gap:10px">
           <select id="stuDiffLevel"><option>HIGH</option><option>MEDIUM</option><option>LOW</option></select>
           <input id="stuDiffYear" value="2025">
        </div>
        <button class="btn" id="createStudentBtn">åˆ›å»ºæ¡£æ¡ˆ</button>
        <div class="muted">å­¦ç”ŸIDï¼š<span id="createdStudentId" class="mono">-</span></div>
      </div>

      <div class="card" id="cardBatchOps">
        <h2>æµç¨‹æµè½¬</h2>
        <div class="muted" style="margin-bottom:15px">åŸºäºä¸Šæ–¹â€œå®¡æ ¸é¡µé¢â€é€‰ä¸­çš„æ‰¹æ¬¡è¿›è¡Œæ“ä½œ</div>
        <div class="btn-group" style="flex-direction:column">
          <button class="btn warn" id="submitCollegeBtn">æäº¤è‡³å­¦é™¢å®¡æ ¸</button>
          <button class="btn warn" id="submitSchoolBtn">æäº¤è‡³å­¦æ ¡å®¡æ ¸</button>
          <button class="btn danger" id="finalizeBtn">å­¦æ ¡ç»ˆå®¡å¹¶é€šçŸ¥</button>
        </div>
      </div>

      <div class="card full-width" id="cardExportStats">
        <h2>æ•°æ®ç»Ÿè®¡ä¸å¯¼å‡º</h2>
        <div class="btn-group">
          <button class="btn secondary" id="exportAppsBtn">ğŸ“¥ å¯¼å‡ºç”³è¯·è¡¨ (CSV)</button>
          <button class="btn secondary" id="exportSummaryBtn">ğŸ“¥ å¯¼å‡ºæ±‡æ€»è¡¨ (CSV)</button>
          <button class="btn secondary" id="statsStyleBtn">ğŸ“Š ç»Ÿè®¡æ¬¾å¼åˆ†å¸ƒ</button>
          <button class="btn secondary" id="statsCollegeBtn">ğŸ“Š ç»Ÿè®¡å­¦é™¢åˆ†å¸ƒ</button>
        </div>
        <div class="list mono" id="statsOut" style="margin-top:15px; background:#f8fafc; padding:15px; min-height:100px; white-space:pre-wrap; font-size:12px">ç­‰å¾…æŸ¥è¯¢...</div>
      </div>

    </div>
  </div>

  <script>
    // é€»è¾‘ä¿æŒåŸæ ·ï¼Œä»…ä¸ºäº†é€‚é…æ–°IDçš„æ˜¾ç¤ºé€»è¾‘åšå¾®è°ƒ
    const api=path=>path
    const j=async r=>{if(!r.ok)throw new Error(await r.text());return r.json()}
    const b=()=>document.getElementById.bind(document)
    let currentRole="counselor"
    const adminHdr=()=>({"X-Admin-User":b()("adminUser").textContent})
    const showToast=(msg,type)=>{const w=b()("toastWrap");const d=document.createElement("div");d.className="toast"+(type?(" "+type):"");d.textContent=msg;w.appendChild(d);setTimeout(()=>{d.style.opacity="0";d.style.transition="opacity .3s";setTimeout(()=>{w.removeChild(d)},300)},2500)}
    const debounce=(fn,delay)=>{let t;return(...args)=>{clearTimeout(t);t=setTimeout(()=>fn(...args),delay)}}
    
    b()("adminLoginBtn").onclick=async()=>{
      try{
        const body=new URLSearchParams()
        body.set("username",b()("adminUsername").value)
        body.set("password",b()("adminPassword").value)
        const r=await j(await fetch(api("/api/admin/login"),{method:"POST",body}))
        b()("adminUser").textContent=r.username
        b()("adminRole").textContent=r.role
        currentRole=r.role
        b()("roleSelect").value=currentRole
        // UI Toggle
        b()("adminLoginCard").style.display="none" // ç™»å½•æˆåŠŸéšè—å¤§å¡ç‰‡ï¼Œå®é™…é€»è¾‘å¯ä»¥æ˜¯ä»…ä»…éšè—è¾“å…¥æ¡†ä¿ç•™å¤´éƒ¨
        // è¿™é‡Œä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬éšè—æ•´ä¸ªç™»å½•å¡ç‰‡ï¼Œæ˜¾ç¤ºDashboard
        b()("adminLoginCard").style.display="none" 
        b()("adminAppCards").style.display="grid" // Switch to grid
        
        // æˆ‘ä»¬å¤ç”¨ LoginCard çš„ä¸€éƒ¨åˆ†ä¿¡æ¯æ˜¾ç¤ºåœ¨ Topbar æˆ–è€…åˆ›å»ºä¸€ä¸ªå°çš„ Info Cardï¼Œè¿™é‡Œç®€å•å¤„ç†ï¼š
        // åœ¨æ§åˆ¶å°é‡Œï¼Œæˆ‘ä»¬ä¸éœ€è¦ä¸€ç›´çœ‹â€œç™»å½•â€å¡ç‰‡ã€‚
        
        const isCounselor=currentRole==="counselor"
        b()("roleSelectWrap").style.display=isCounselor?"":"none"
        const show=(id,visible)=>{const el=b()(id); if(el) el.style.display=visible?"":"none"}
        show("cardCreateBatch",isCounselor)
        show("cardSelectionDeadline",isCounselor)
        show("cardCreateStyle",isCounselor)
        show("cardCreateStudent",isCounselor)
        show("cardBatchOps",isCounselor)
        show("cardExportStats",isCounselor) // å¯¼å‡ºé€šå¸¸ä¹Ÿç»™è¾…å¯¼å‘˜çœ‹å—ï¼ŸæŒ‰åŸé€»è¾‘æ˜¯çš„
        show("cardReview",true)
        const batchId=b()("revBatchIdInline").value
        if(batchId){await b()("loadAppsBtn").onclick()} else {showToast("è¯·å¡«å†™æ‰¹æ¬¡IDä»¥åŠ è½½å®¡æ ¸åˆ—è¡¨")}
      }catch(e){
        showToast("ç™»å½•å¤±è´¥: " + e.message, "error")
      }
    }
    b()("roleSelect").onchange=()=>{currentRole=b()("roleSelect").value}
    b()("openBatchBtn").onclick=async()=>{
      try {
        const body=new URLSearchParams()
        body.set("year",b()("batchYear").value)
        body.set("difficultyYear",b()("diffYear").value)
        body.set("difficultyLevel",b()("diffLevel").value)
        body.set("applicationDeadlineIso",b()("applyDeadline").value)
        const r=await j(await fetch(api("/api/admin/batch/open"),{method:"POST",headers:adminHdr(),body}))
        b()("openedBatchId").textContent=r.batchId
        b()("selBatchId").value=r.batchId
        const sel=b()("revBatchIdInline")
        const exists=[...sel.options].some(o=>o.value==r.batchId)
        if(!exists){const opt=document.createElement("option");opt.value=r.batchId;opt.textContent="æ‰¹æ¬¡ "+r.batchId;sel.appendChild(opt)}
        sel.value=r.batchId
        await b()("loadAppsBtn").onclick()
        showToast("æ‰¹æ¬¡åˆ›å»ºæˆåŠŸ")
      } catch(e) { showToast(e.message, "error") }
    }
    b()("setSelDeadlineBtn").onclick=async()=>{
      try{
        const body=new URLSearchParams()
        body.set("batchId",b()("selBatchId").value)
        body.set("deadlineIso",b()("selDeadline").value)
        await j(await fetch(api("/api/admin/batch/deadline/selection"),{method:"POST",headers:adminHdr(),body}))
        showToast("é€‰æ‹©æˆªæ­¢è®¾ç½®æˆåŠŸ")
      } catch(e) { showToast(e.message, "error") }
    }
    b()("createStyleBtn").onclick=async()=>{
      try{
        const variants=JSON.parse(b()("styleVariants").value||"[]")
        const name=encodeURIComponent(b()("styleName").value)
        const gender=encodeURIComponent(b()("styleGender").value)
        const imageUrl=encodeURIComponent(b()("styleImage").value)
        const url=`/api/admin/styles/create?name=${name}&gender=${gender}&imageUrl=${imageUrl}`
        const r=await j(await fetch(api(url),{method:"POST",headers:Object.assign({"Content-Type":"application/json"},adminHdr()),body:JSON.stringify(variants)}))
        b()("createdStyleId").textContent=r.styleId
        showToast("æ¬¾å¼åˆ›å»ºæˆåŠŸ")
      } catch(e) { showToast(e.message, "error") }
    }
    b()("createStudentBtn").onclick=async()=>{
      try{
        const body=new URLSearchParams()
        body.set("studentNumber",b()("stuNum").value)
        body.set("name",b()("stuName").value)
        body.set("gender",b()("stuGender").value)
        body.set("idCardNumber",b()("stuIdCard").value)
        body.set("entryYear",b()("stuEntryYear").value)
        body.set("collegeName",b()("stuCollege").value)
        body.set("difficultyLevel",b()("stuDiffLevel").value)
        body.set("difficultyYear",b()("stuDiffYear").value)
        const r=await j(await fetch(api("/api/admin/students/create"),{method:"POST",headers:adminHdr(),body}))
        b()("createdStudentId").textContent=r.studentId
        showToast("å­¦ç”Ÿæ¡£æ¡ˆåˆ›å»ºæˆåŠŸ")
      } catch(e) { showToast(e.message, "error") }
    }
    b()("submitCollegeBtn").onclick=async()=>{
      if(!confirm("ç¡®è®¤æäº¤è‡³å­¦é™¢ï¼Ÿ")) return;
      const body=new URLSearchParams()
      body.set("batchId",b()("revBatchIdInline").value)
      await j(await fetch(api("/api/admin/submit/college"),{method:"POST",headers:adminHdr(),body}))
      showToast("å·²æäº¤è‡³å­¦é™¢")
    }
    b()("submitSchoolBtn").onclick=async()=>{
      if(!confirm("ç¡®è®¤æäº¤è‡³å­¦æ ¡ï¼Ÿ")) return;
      const body=new URLSearchParams()
      body.set("batchId",b()("revBatchIdInline").value)
      await j(await fetch(api("/api/admin/submit/school"),{method:"POST",headers:adminHdr(),body}))
      showToast("å·²æäº¤è‡³å­¦æ ¡")
    }
    b()("finalizeBtn").onclick=async()=>{
      if(!confirm("ç¡®è®¤è¿›è¡Œå­¦æ ¡ç»ˆå®¡å¹¶å‘å¸ƒé€šçŸ¥ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ã€‚")) return;
      const body=new URLSearchParams()
      body.set("batchId",b()("revBatchIdInline").value)
      await j(await fetch(api("/api/admin/finalize"),{method:"POST",headers:adminHdr(),body}))
      showToast("ç»ˆå®¡å®Œæˆå¹¶å·²é€šçŸ¥å­¦ç”Ÿ")
    }
    const downloadCsv=async url=>{
      try{
        const r=await fetch(api(url),{headers:adminHdr()})
        if(!r.ok)throw new Error("ä¸‹è½½å¤±è´¥")
        const blob=await r.blob()
        const a=document.createElement("a")
        a.href=URL.createObjectURL(blob)
        a.download=url.includes("summary")?"summary.csv":"applications.csv"
        a.click()
        URL.revokeObjectURL(a.href)
      } catch(e) { showToast(e.message, "error") }
    }
    b()("exportAppsBtn").onclick=()=>downloadCsv("/api/admin/export/applications.csv?batchId="+encodeURIComponent(b()("revBatchIdInline").value))
    b()("exportSummaryBtn").onclick=()=>downloadCsv("/api/admin/export/summary.csv?batchId="+encodeURIComponent(b()("revBatchIdInline").value))
    b()("statsStyleBtn").onclick=async()=>{
      const r=await j(await fetch(api("/api/admin/stats/style-gender-size?batchId="+encodeURIComponent(b()("revBatchIdInline").value)),{headers:adminHdr()}))
      b()("statsOut").textContent=JSON.stringify(r,null,2)
    }
    b()("statsCollegeBtn").onclick=async()=>{
      const r=await j(await fetch(api("/api/admin/stats/college-style-gender-size?batchId="+encodeURIComponent(b()("revBatchIdInline").value)),{headers:adminHdr()}))
      b()("statsOut").textContent=JSON.stringify(r,null,2)
    }
    const renderRadio=(name,current)=>[
      `<div class="radio-group">
      <label><input type="radio" name="${name}" value="APPROVED" ${current==="APPROVED"?"checked":""}><span style="color:#10b981">é€šè¿‡</span></label>`,
      `<label><input type="radio" name="${name}" value="PENDING" ${current==="PENDING"?"checked":""}><span style="color:#64748b">å¾…å®š</span></label>`,
      `<label><input type="radio" name="${name}" value="REJECTED" ${current==="REJECTED"?"checked":""}><span style="color:#ef4444">æ‹’ç»</span></label>
      </div>`
    ].join("")
    
    const actReview=async(stage,id,status,rejectReason)=>{
      const url=stage==="counselor"?"/api/admin/review/counselor":stage==="college"?"/api/admin/review/college":"/api/admin/review/school"
      const body=new URLSearchParams()
      body.append("applicationIds",id)
      body.set("status",status)
      if(status==="REJECTED" && rejectReason) body.set("rejectReason",rejectReason)
      await j(await fetch(api(url),{method:"POST",headers:adminHdr(),body}))
    }
    b()("loadAppsBtn").onclick=async()=>{
      const batchId=b()("revBatchIdInline").value
      if(!batchId){showToast("è¯·å¡«å†™æ‰¹æ¬¡ID", "error");return}
      const size=parseInt(b()("revPageSize").value,10)||20
      try{
        const r=await j(await fetch(api("/api/admin/applications?batchId="+encodeURIComponent(batchId)+"&page=0&size="+size),{headers:adminHdr()}))
        const list=r.content||[]
        const box=b()("appsList")
        if(list.length === 0) { box.innerHTML = '<div style="padding:20px;text-align:center;color:#999">æš‚æ— ç”³è¯·æ•°æ®</div>'; return; }
        box.innerHTML=list.map(a=>{
          const cName="c-"+a.id, colName="col-"+a.id, schName="sch-"+a.id
          const showC=currentRole==="counselor"
          const showCol=currentRole==="college"
          const showSch=currentRole==="school"
          return `<div class="review-item">
            <div class="review-header">
               <div><b>${a.student.name}</b> <span class="muted" style="margin-left:8px">${a.student.studentNumber} Â· ${a.student.collegeName}</span></div>
               <div class="muted">ID: ${a.id}</div>
            </div>
            
            <div class="status-row">
              <span class="status-label">è¾…å¯¼å‘˜</span>
              ${renderRadio(cName,a.counselorStatus)} 
              ${showC?`<button class="btn" style="margin:0;padding:4px 10px;height:28px" data-stage="counselor" data-id="${a.id}" data-src="${cName}">ä¿å­˜</button>`:''}
            </div>
            
            <div class="status-row">
              <span class="status-label">å­¦é™¢</span>
              ${renderRadio(colName,a.collegeStatus)} 
              ${showCol?`<button class="btn" style="margin:0;padding:4px 10px;height:28px" data-stage="college" data-id="${a.id}" data-src="${colName}">ä¿å­˜</button>`:''}
            </div>

            <div class="status-row">
              <span class="status-label">å­¦æ ¡</span>
              ${renderRadio(schName,a.schoolStatus)} 
              ${showSch?`<button class="btn" style="margin:0;padding:4px 10px;height:28px" data-stage="school" data-id="${a.id}" data-src="${schName}">ä¿å­˜</button>`:''}
            </div>

            <div style="display:flex;align-items:center;gap:10px; margin-top:4px">
              <span class="status-label">æ‹’ç»ç†ç”±</span>
              <input type="text" id="rej-${a.id}" value="${a.rejectReason||""}" placeholder="è‹¥æ‹’ç»è¯·å¡«å†™ç†ç”±..." style="flex:1;padding:6px;font-size:13px">
            </div>
            <div class="muted" style="text-align:right">çŠ¶æ€æµè½¬ï¼šå­¦é™¢å·²æäº¤ ${a.submittedToCollege?"âœ…":"âŒ"} Â· å­¦æ ¡å·²æäº¤ ${a.submittedToSchool?"âœ…":"âŒ"}</div>
          </div>`
        }).join("")
        box.querySelectorAll("button[data-stage]").forEach(btn=>{
          btn.onclick=async()=>{
            const id=btn.getAttribute("data-id")
            const group=btn.getAttribute("data-src")
            const picked=b().call(document, group)?document.querySelector(`input[name="${group}"]:checked`):null
            if(!picked){alert("è¯·é€‰æ‹©çŠ¶æ€");return}
            const status=picked.value
            const stage=btn.getAttribute("data-stage")
            const reason=b()(`rej-${id}`).value
            await actReview(stage,id,status,reason)
            showToast("ä¿å­˜æˆåŠŸ")
          }
        })
      } catch(e) { showToast(e.message, "error") }
    }
    const debouncedLoad=debounce(()=>b()("loadAppsBtn").onclick(),400)
    b()("revBatchIdInline").addEventListener("change",debouncedLoad)
  </script>
</body>
</html>